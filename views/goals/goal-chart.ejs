<!DOCTYPE html>
<html lang="en">

<head>
  <%- include('../includes/header.ejs') %>
</head>

<body>
  <%- include('../includes/nav.ejs') %>
  <main class="container">
    <%- include('../includes/messages.ejs') %>
    <a href="/goals/goal-list" class="btn btn-dark mt-3"><small>Back to Goals</small></a>
    <h1 class="text-center">
      <%= goal.goalName %>
    </h1>
    <canvas id="myChart" width="400" height="400"></canvas>

    <div id="dataDetails"></div>

    <form action="/goals/goal/add-data/<%= goal._id %>" method="POST">
      <input type="hidden" name="_csrf" value="<%= csrfToken %>">
      <div class="form-group">
        <label for="hours">Hours Spent</label>
        <input class="form-control" type="number" name="hours" id="hours" value="0">
      </div>
      <div class="text-center">
        <button class="btn btn-dark" type="submit">Submit Hours</button>
      </div>
    </form>
  </main>

  <input type="hidden" id="goalName" value="<%= goal.goalName %>">
  <input type="hidden" id="chartType" value="<%= goal.chartType %>">
  <input type="hidden" id="daysToTrack" value="<%= goal.daysToTrack %>">
  <input type="hidden" id="dataSet" value="<%= JSON.stringify(goal.dataSet) %>">
  <input type="hidden" id="backgroundColor" value="<%= goal.backgroundColor %>">
  <input type="hidden" id="borderColor" value="<%= goal.borderColor %>">

  <%- include('../includes/footer.ejs') %>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.js"></script>
  <script>

    var dataDetails = document.querySelector('#dataDetails');
    var goal = {};
    goal.goalName = document.querySelector('#goalName').value;
    goal.chartType = document.querySelector('#chartType').value;
    goal.daysToTrack = document.querySelector('#daysToTrack').value;
    goal.dataSet = JSON.parse(document.querySelector('#dataSet').value);
    goal.backgroundColor = document.querySelector('#backgroundColor').value;
    goal.borderColor = document.querySelector('#borderColor').value;

    if (goal.dataSet === "") {
      goal.dataSet = [];
    }
    console.log(goal)

    function createChartLables(numOfDays) {
      var result = [];
      for (var i = 1; i <= numOfDays; i++) {
        result.push(i);
      }
      return result;
    };

    function renderChart(goal) {
      var chartLabels = createChartLables(goal.daysToTrack);
      var data = {
        label: goal.goalName,
        data: goal.dataSet,
        backgroundColor: goal.backgroundColor,
        borderColor: goal.borderColor,
        borderWidth: 1
      };

      var ctx = document.getElementById("myChart");

      var myChart = new Chart(ctx, {
        type: goal.chartType,
        data: {
          labels: chartLabels,
          datasets: [data]
        },
        options: {
          scales: {
            yAxes: [{
              scaleLabel: {
                display: true,
                labelString: 'Hours'
              },
              ticks: {
                beginAtZero: true,
                max: 24,
                min: 0
              }
            }],
            xAxes: [{
              scaleLabel: {
                display: true,
                labelString: 'Days'
              }
            }]
          },
          responsive: true
        },
        plugins: [{
          beforeDraw: function (c) {
            var chartHeight = c.chart.height;
            c.scales['y-axis-0'].options.ticks.fontSize = chartHeight * 6 / 100; //fontSize: 6% of canvas height
          }
        }]
      });

      document.getElementById("myChart").addEventListener('click', (e) => {
        var activePoints = myChart.getElementsAtEvent(e);
        if (activePoints[0] !== undefined) {
          dataDetails.innerHTML = `
              <h3>Details</h3>
              <p>Day: ${activePoints[0]._index + 1}</p>
              <p>Hours: ${goal.dataSet[activePoints[0]._index]}</p>
            `;
          console.log(activePoints[0]);
          console.log('Hours', goal.dataSet[activePoints[0]._index]);
          console.log('Day', activePoints[0]._index + 1);
        }
      });
    };

    renderChart(goal);

    // var goalName = document.getElementById('goalName').value;
    // // const chartType = document.getElementById('chartType').value;
    // // const daysToTrack = document.getElementById('daysToTrack').value;
    // // const backgroundColor = document.getElementById('backgroundColor').value;
    // // const borderColor = document.getElementById('borderColor').value;
    // // let dataSet = document.getElementById('dataSet').value;

    // var ctx = document.querySelector("#myChart").getContext('2d');
    // var myChart = new Chart(ctx, {
    //   type: 'line',
    //   data: {
    //     labels: [1500, 1600, 1700, 1750, 1800, 1850, 1900, 1950, 1999, 2050],
    //     datasets: [{
    //       data: [86, 114, 106, 106, 107, 111, 133, 221, 783, 2478],
    //       label: "Africa",
    //       borderColor: "#3e95cd",
    //       fill: false
    //     }]
    //   },
    //   options: {
    //     title: {
    //       display: true,
    //       text: 'World population per region (in millions)'
    //     }
    //   }
    // });
  </script>
</body>

</html>